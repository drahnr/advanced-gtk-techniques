<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Setting up Automake</title>
<link rel="stylesheet" type="text/css" href="C.css">
<script type="text/javascript" src="jquery.js"></script><script type="text/javascript" src="yelp.js"></script><link rel="stylesheet" href="../index.css" type="text/css">
<script src="../highlight.pack.js"></script><script>
$(document).ready(function() {
  $('div.code pre').each(function(i, e) {hljs.highlightBlock(e, '    ')});
});
    </script><link rel="stylesheet" href="http://yandex.st/highlightjs/6.1/styles/github.min.css">
</head>
<body>
<div class="banner">
<h1 class="banner"><a href="#"><span>Advanced GTK Techniques</span></a></h1>
<h2 class="banner"><span>Setting up Automake</span></h2>
</div>
<div class="links nextlinks">« <a class="nextlinks-prev" href="autoconf-project.html" title="Setting up Autoconf">Setting up <span class=" app">Autoconf</span></a> :: <a class="nextlinks-contents" href="real-life-app-setup.html" title="Setting up a real-life GTK application">Contents</a> :: <a class="nextlinks-next" href="desktop-file.html" title="Icons and desktop files">Icons and desktop files</a> »</div>
<div class="page" role="main">
<div class="header"><div class="trails" role="navigation"><div class="trail">
<a class="trail" href="index.html" title="Advanced GTK Techniques">Advanced GTK Techniques</a> » <a class="trail" href="real-life-app-setup.html" title="Setting up a real-life GTK application">Setting up a real-life GTK application</a> » </div></div></div>
<div class="body">
<div class="hgroup"><h1 class="title"><span class="title">Setting up <span class=" app">Automake</span></span></h1></div>
<div class="region">
<div class="contents">
<div class="synopsis"><div class="inner"><div class="region"><div class="contents">
<p class="p">In this tutorial, you will learn:</p>
<div class="list"><div class="inner"><div class="region"><ul class="list">
<li class="list"><p class="p">How to generate a Makefile saying which files to compile</p></li>
<li class="list"><p class="p">How to check for the libraries your program needs</p></li>
</ul></div></div></div>
<p class="p">This tutorial is part of the <span class=" em">Setting up a real-life GTK application</span> series.
If you don't want to follow along with the previous parts, simply copy the <span class=" link"><a href="../app-skeleton1" title="../app-skeleton1"><span class=" file">app-skeleton1</span></a></span> directory from the tutorial's code examples.
Or, you can start from the <span class=" link"><a href="real-life-app-setup.html" title="Setting up a real-life GTK application">beginning</a></span>.</p>
</div></div></div></div>
<p class="p">Now to move on to Automake, the other major component of our build system.
After we get Automake set up, we can start writing some source code.</p>
<p class="p">Make is a program that reads a file called <span class=" file">Makefile</span> that describes how to compile source code into executable code.
The contents of a <span class=" file">Makefile</span> depend upon the compiler you use, the system you are on, and many other things.
<span class=" file">Makefile</span>s can also get quite long if you want to implement all the standard make targets described in the <span class=" link"><a href="autoconf-project.html" title="Setting up Autoconf">previous section</a></span>.</p>
<p class="p">This is where Automake comes in.
Automake allows you to write the Make code in a more abstract, platform-independent way.
Automake looks for Automake files named <span class=" file">Makefile.am</span>, and changes them into almost-Makefiles named <span class=" file">Makefile.in</span>.
These almost-Makefiles are then transformed into real <span class=" file">Makefile</span>s when you run <span class=" cmd">configure</span>.</p>
</div>
<div id="creating-makefile-am" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">Creating a <span class=" file">Makefile.am</span></span></h2></div>
<div class="region"><div class="contents">
<p class="p">To get started, copy your <span class=" file">app-skeleton1</span> directory to a new <span class=" file">app-skeleton2</span> directory, or just rename it if you like.
For now, just put one line in <span class=" file">Makefile.am</span>:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/Makefile.am" title="../app-skeleton2/Makefile.am">app-skeleton2/Makefile.am</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">SUBDIRS = src</pre></div></div></div>
</div></div>
<p class="p">The special <span class=" code">SUBDIRS</span> variable tells Automake to look for another <span class=" file">Makefile.am</span> in the <span class=" file">src</span> subdirectory as well.
The resulting <span class=" file">Makefile</span> will also look for <span class=" file">src/Makefile</span> and call it recursively as well.</p>
<div class="note" title="Note"><div class="inner">
<div class="title title-note"><h3><span class="title">Recursive Make</span></h3></div>
<div class="region"><div class="contents"><p class="p">A famous paper by Peter Miller has a title that speaks volumes about what some people think about writing your <span class=" file">Makefile</span>s recursively:
  <span class=" link"><a href="http://miller.emu.id.au/pmiller/books/rmch/" title="http://miller.emu.id.au/pmiller/books/rmch/">Recursive Make Considered Harmful</a></span>.
  Read it and follow its advice if you like; it's not more or less difficult than the approach shown here.
  In practice, however, most projects use recursive make, so it's important to be familiar with it at least.</p></div></div>
</div></div>
<p class="p">Since we are telling Automake to go into the <span class=" file">src</span> directory, we should also put something there for it to find.
We need a <span class=" file">Makefile.am</span>, but perhaps more importantly, we need some source code.
We are going to be writing our own application starting in the next section, but until then we need some "placeholder" source code.
We will use the "Hello World" example from the GTK tutorial.
Instead of retyping it or copying and pasting it from the browser, we will fetch it the way real hackers do it: the lazy way!
Create a <span class=" file">src</span> directory, <span class=" cmd">cd</span> to it, and type in your terminal:</p>
<div class="screen"><pre class="contents "><span class=" input">wget http://git.gnome.org/browse/gtk+/plain/examples/hello-world.c</span></pre></div>
<p class="p">Now we can create a <span class=" file">Makefile.am</span> to compile this source code.
Write in <span class=" file">src/Makefile.am</span> (be careful to get the right file, don't use the one in the parent directory):</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/src/Makefile.am" title="../app-skeleton2/src/Makefile.am">app-skeleton2/src/Makefile.am</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">bin_PROGRAMS = app-skeleton
app_skeleton_SOURCES = hello-world.c</pre></div></div></div>
</div></div>
<p class="p">Automake works mostly by setting variables.
<span class=" code">SUBDIRS</span> was an example of one.
Many other Automake variables have names consisting of two parts.
For example, a variable named <span class=" code"><span class=" var">something</span>_PROGRAMS</span> is a list of executable programs for Automake to build.
The <span class=" var">something</span> part tells where to install the programs when you run <span class=" cmd">make install</span>.
So <span class=" code">bin_PROGRAMS = app-skeleton</span> means that Automake should generate a <span class=" file">Makefile</span> that builds a program named <span class=" file">app-skeleton</span> and installs it in <span class=" file">/usr/local/bin</span>.
(Unless you decide it should be called something else and installed somewhere else; Automake's <span class=" file">Makefile</span>s are highly customizable using <span class=" cmd">configure</span>, but I will leave explaining that to one of the Autotools tutorials I mentioned <span class=" link"><a href="real-life-app.html" title="real-life-app">previously</a></span>.)</p>
<p class="p">By the same tack, <span class=" code">app_skeleton_SOURCES = hello-world.c</span> means that the program named <span class=" file">app-skeleton</span> should be built from the source file <span class=" file">hello-world.c</span>, which we just downloaded.
(If the name of the program contains characters that are not legal in a variable name, Automake replaces them with underscores.)</p>
<p class="p">We must now instruct <span class=" cmd">configure</span> to generate our newly-written <span class=" file">Makefile</span>.
Replace the <span class=" code">AC_CONFIG_FILES</span> call in <span class=" file">configure.ac</span> with this:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/configure.ac" title="../app-skeleton2/configure.ac">app-skeleton2/configure.ac</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">AC_CONFIG_FILES([
	Makefile
	src/Makefile
])</pre></div></div></div>
</div></div>
<p class="p">Finally, we also need to tell <span class=" cmd">configure</span> to look for a suitable C compiler.
Add the single command <span class=" code">AC_PROG_CC</span> after the <span class=" code">AM_INIT_AUTOMAKE</span> line.
(CC stands for C Compiler.)</p>
<p class="p">Then, run <span class=" cmd">autoreconf</span> and <span class=" cmd">./configure</span>.
The output from <span class=" cmd">configure</span> is a little longer (you can see that it is checking for a C compiler) and more files have appeared when it is done.
So far, so good.
But when we run <span class=" cmd">make</span>, we get a screen full of errors: all of the GTK functions used in the file are undefined, and the compiler cannot find the <span class=" file">gtk/gtk.h</span> header.</p>
</div></div>
</div></div>
<div id="defining-libraries" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">Defining our libraries</span></h2></div>
<div class="region"><div class="contents">
<p class="p">We need to define what libraries the program will use.
This is done in <span class=" file">configure.ac</span>, so that <span class=" cmd">configure</span> can look for these libraries and put their locations into the <span class=" file">Makefile</span>.
We will also take this opportunity to organize <span class=" file">configure.ac</span> and introduce a few more Autoconf macros.</p>
<p class="p">Divide the <span class=" file">configure.ac</span> file into four sections:</p>
<div class="list"><div class="inner"><div class="region"><ul class="list">
<li class="list"><p class="p"><span class=" em">Initialization</span>, in which we do preparations for initializing the build system;</p></li>
<li class="list"><p class="p"><span class=" em">Shopping list</span>, in which we tell Autoconf what tools we would like to use. 
  The resulting <span class=" cmd">configure</span> script will go look for those tools and complain if they are not installed;</p></li>
<li class="list"><p class="p"><span class=" em">Libraries</span>, in which we list what libraries we are using.
  Again, <span class=" cmd">configure</span> will complain if these libraries are not installed;</p></li>
<li class="list"><p class="p">and <span class=" em">Output</span>, where we output all the results of these checks so that Make can use them.</p></li>
</ul></div></div></div>
<div class="note" title="Note"><div class="inner">
<div class="title title-note"><h3><span class="title">Comments</span></h3></div>
<div class="region"><div class="contents"><p class="p">You can use comments, which start with the <span class=" code">#</span> character, to divide up the file.
  Autoconf comments can also be started by the letters <span class=" code">dnl</span> (which stands for Delete until New Line.)
  The difference between the two is that <span class=" code">dnl</span> comments are ignored completely by Autoconf, whereas <span class=" code">#</span> comments are copied into the generated <span class=" file">configure</span> file.
  This can be useful if there is an error in <span class=" file">configure</span> and you want to find out which section of <span class=" file">configure.ac</span> is causing it.</p></div></div>
</div></div>
<p class="p">In the Initialization section, write:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/configure.ac" title="../app-skeleton2/configure.ac">app-skeleton2/configure.ac</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">AC_INIT([App Skeleton], [2], [philip.chimento@gmail.com])
AC_CONFIG_SRCDIR([src/hello-world.c])
AM_INIT_AUTOMAKE([-Wall foreign])
AM_SILENT_RULES([yes])</pre></div></div></div>
</div></div>
<p class="p">We have changed the version number to 2 here. There are also two new macros:</p>
<div class="terms"><div class="inner"><div class="region"><dl class="terms">
<dt class="terms"><span class=" code">AC_CONFIG_SRCDIR</span></dt>
<dd class="terms"><p class="p">This is a safety check to make sure the source tree actually contains the source code that it should.
    As an argument, put the name of a unique source file in your program; here we put our only source file.</p></dd>
<dt class="terms"><span class=" code">AM_SILENT_RULES</span></dt>
<dd class="terms">
<p class="p">The generated <span class=" file">Makefile</span>s use very long compiler command lines.
    Normally, you don't need to see these, and large swathes of garbage scrolling across your terminal can actually obscure error and warning messages.
    <span class=" code">AM_SILENT_RULES</span> adds the capability to your <span class=" file">Makefile</span>s to suppress the build commands, instead printing just a short summary.
    The <span class=" code">yes</span> argument turns this behavior on by default.
    A <span class=" em">Real Programmer</span> might write <span class=" code">AM_SILENT_RULES([no])</span> and then lesser mortals could run <span class=" cmd">./configure --enable-silent-rules</span> to get the quiet building behavior.</p>
<p class="p">If you have silent rules turned on, and you want to examine the command lines after all, perhaps to track down an error, you can run <span class=" cmd">make V=1</span> to get the command lines back temporarily.
    (<span class=" code">V</span> stands for Verbose.)</p>
</dd>
</dl></div></div></div>
<p class="p">In the Shopping List section, write:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/configure.ac" title="../app-skeleton2/configure.ac">app-skeleton2/configure.ac</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">AC_PROG_CC
PKG_PROG_PKG_CONFIG</pre></div></div></div>
</div></div>
<p class="p">The new macro here is <span class=" code">PKG_PROG_PKG_CONFIG</span>.
It adds the <span class=" cmd">pkg-config</span> program to our shopping list of tools.
This macro doesn't start with <span class=" code">AC_</span> or <span class=" code">AM_</span>, so it doesn't originate from Autoconf or Automake.
Instead, the prefix <span class=" code">PKG_</span> identifies it as belonging to the macros that <span class=" cmd">pkg-config</span> provides when you install it.</p>
<p class="p">The Libraries section is where we use <span class=" cmd">pkg-config</span>:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/configure.ac" title="../app-skeleton2/configure.ac">app-skeleton2/configure.ac</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">PKG_CHECK_MODULES([APP_SKELETON], [
	glib-2.0
	gtk+-3.0
])</pre></div></div></div>
</div></div>
<p class="p">The <span class=" code">PKG_CHECK_MODULES</span> macro takes a program name, in this case <span class=" code">APP_SKELETON</span> as its first argument, and a list of <span class=" cmd">pkg-config</span> <span class=" em">modules</span> as its second.
A module is the name of a library as it is known to <span class=" cmd">pkg-config</span>.
This macro uses <span class=" cmd">pkg-config</span> to look for these libraries, and creates two variables:
<span class=" code">APP_SKELETON_CFLAGS</span> which contains the C compiler flags required for compiling with these libraries, 
and <span class=" code">APP_SKELETON_LIBS</span> which contains the linker flags.
These variables are available from inside the <span class=" file">Makefile</span>s.</p>
<p class="p">These module names specify that we are using the 2.0 series of the GLib library and the 3.0 series of the GTK+ library.
If you don't know the module name of a library, you can always look in <span class=" file">/usr/share/pkgconfig</span> and <span class=" file">/usr/lib/pkgconfig</span> to see if there is a <span class=" file">.pc</span> that corresponds to the library name.
Some libraries aren't configurable by <span class=" cmd">pkg-config</span>; there are other ways to check for libraries, but I won't describe them here.</p>
<p class="p">Finally, the Output section is the same as before:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/configure.ac" title="../app-skeleton2/configure.ac">app-skeleton2/configure.ac</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">AC_CONFIG_FILES([
	Makefile
	src/Makefile
])
AC_OUTPUT</pre></div></div></div>
</div></div>
<p class="p">After that, we need to use the <span class=" code">APP_SKELETON_CFLAGS</span> and <span class=" code">APP_SKELETON_LIBS</span> variables in our <span class=" file">Makefile.am</span>.
Edit <span class=" file">src/Makefile.am</span> so that it looks like this:</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title"><span class=" file"><a href="../app-skeleton2/src/Makefile.am" title="../app-skeleton2/src/Makefile.am">app-skeleton2/src/Makefile.am</a></span></span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents ">AM_CFLAGS = $(APP_SKELETON_CFLAGS)
bin_PROGRAMS = app-skeleton
app_skeleton_SOURCES = hello-world.c
app_skeleton_LDADD = $(APP_SKELETON_LIBS)</pre></div></div></div>
</div></div>
<p class="p">The <span class=" code">AM_CFLAGS</span> variable contains the compiler flags to be added to all compilations defined in this <span class=" file">Makefile.am</span>.
Conversely, the <span class=" code">app_skeleton_LDADD</span> variable tells Automake the linker flags to use when linking the <span class=" file">app-skeleton</span> program.</p>
<p class="p">Now when we rebuild, everything should work fine.
Note that we only have to type <span class=" cmd">make</span> to rebuild; the magic of the generated <span class=" file">Makefile</span> (now a whopping 22 kilobytes) makes sure that <span class=" file">configure</span> is regenerated and rerun, which also regenerates the <span class=" file">Makefile</span>.</p>
<p class="p">You can run the executable <span class=" file">app-skeleton</span> to verify that it does what it should:
shows a window with a <span class=" gui">Hello World</span> button which, when pressed, prints <span class=" output">Hello World</span> to the terminal and exits.</p>
<p class="p">Now that we have a build system in place, there are a few more bits of infrastructure we need to examine: installation and internationalization.</p>
</div></div>
</div></div>
<div class="sect sect-links" role="navigation">
<div class="hgroup"></div>
<div class="contents"><div class="links guidelinks"><div class="inner">
<div class="title"><h2><span class="title">More Information</span></h2></div>
<div class="region"><ul><li class="links ">
<a href="real-life-app-setup.html" title="Setting up a real-life GTK application">Setting up a real-life GTK application</a><span class="desc"> — Putting together the build infrastructure for an application</span>
</li></ul></div>
</div></div></div>
</div>
</div>
<div class="clear"></div>
</div>
<div class="footer"><div class="sect about ui-expander" role="contentinfo">
<div class="yelp-data yelp-data-ui-expander" data-yelp-expanded="false"></div>
<div class="inner">
<div class="hgroup"><h2><span class="title">About</span></h2></div>
<div class="region"><div class="contents">
<div class="copyrights"><div class="copyright">© 2008-2012 Philip Chimento</div></div>
<div class="aboutblurb authors">
<div class="title"><span class="title">Written By</span></div>
<ul class="credits"><li>Philip Chimento</li></ul>
</div>
<div class="aboutblurb maintainers">
<div class="title"><span class="title">Maintained By</span></div>
<ul class="credits"><li>Philip Chimento</li></ul>
</div>
<div class="aboutblurb license">
<div class="title"><span class="title">Creative Commons</span></div>
<div class="contents"><p class="p">This work is licensed under a <span class=" link"><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" title="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a></span>.</p></div>
</div>
</div></div>
</div>
</div></div>
</div>
<div class="links nextlinks">« <a class="nextlinks-prev" href="autoconf-project.html" title="Setting up Autoconf">Setting up <span class=" app">Autoconf</span></a> :: <a class="nextlinks-contents" href="real-life-app-setup.html" title="Setting up a real-life GTK application">Contents</a> :: <a class="nextlinks-next" href="desktop-file.html" title="Icons and desktop files">Icons and desktop files</a> »</div>
</body>
</html>
